# 토큰기반인증방식

토큰기반 인증방식은 state를 모두 토큰 자체만으로 처리한다.
토큰을 처리하는 한 서버를 두고, 다른 콘텐츠를 제공하는 서버는 모두 stateless하게 만들자는 이론이 담긴 방식이다.

### 왜 토큰 관리 서버를 따로 두나요?

이는 여러 개의 서버를 운용한다고 했을 때, 토큰기반인증 + A도메인을 처리하는 서버로 구축하면 A도메인에서 에러가 발생하면 인증에 관한 기능이 마비된다.
이는 B, C, D 등의 도메인 기능이 연쇄적으로 마비될 수도 있다.

### 무슨 토큰을 사용하나?

JWT 토큰이 활용된다.

1. 인증로직 > JWT 토큰 생성 (access 토큰, refresh 토큰)
2. 사용자가 이후에 access 토큰을 HTTP Header - Authorization 또는 HTTP Header - Cookie에 담아 인증이 필요한 서버에 요청해 원하는 컨텐츠를 가져온다.

### JWT란?

JWT는 JSON Web Token을 의미한다.
헤더, 페이로드, 서명으로 이뤄져 있다.
JSON 객체로 인코딩되며 메시지 인증, 암호화에 사용된다.

`Header`

토큰 유형과 서명알고리즘, base64URI로 인코딩된다.

`Payload`

데이터, 토큰 발급자, 토큰 유효기간, base64URI로 인코딩된다.

`Signature`

인코딩된 header + payload + 비밀키를 기반으로 헤더에 명시된 알고리즘으로 다시 생성한 서명값이다.

### 장점

1. 사용자 인증에 필요한 모든 정보는 토큰 자체에 포함하기 때문에 별도의 인증 저장소가 필요없다.
2. 다른 유형의 토큰과 비교했을 때, 경량화되어있다.
   SAML(Security Assertion Markup Language Tokens)이란 토큰이 있지만, 이에 비해 훨씬 경량화되어있다.
3. 디코딩했을 때, JSON이 나오기 때문에, JSON을 기반으로 쉽게 직렬화, 역직렬화가 가능하다.

### 단점

1. 토큰이 비대해질 경우, 당연히 서버과부화에 영향을 줄 수 있다.
2. 토큰을 탈취당할 경우, 디코딩했을 때 데이터를 볼 수 있다.

### 토큰 종류와 특징

> 로그인을 하면 아래 두 가지 토큰을 얻는다.

1. access토큰

수명이 짧다.

2. refresh토큰

수명이 길다.
access토큰이 만료됐을 때, 다시 access 토큰을 얻기 위해 사용된다.
이를 통해, access 토큰이 만료됐을 때마다 인증에 관한 비용이 줄어든다.

### 주의할 점

access 토큰을 얻었다면, 그 이후에 요청을 할 때는 HTTP Header - Authorization 또는 HTTP - Cookie에 담아 요청을 한다.
이 때 다음과 같은 규칙을 지킼는 게 좋다.

- Bearer <token> 으로 Bearer을 앞에 둬서 토큰기반인증방식이라는 것을 알려줘야 한다.
- https를 사용해야 한다.
- 쿠키에 저장한다면, sameSite: 'Strict'를 써야 한다.
- 수명이 짧은 access 토큰을 발급해야 한다.
- url에 토큰을 전달하지 말아야 한다.
