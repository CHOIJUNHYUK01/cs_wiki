# TLS 핸드셰이크

SSL(Secure Socket Layer)은 SSL 1.0부터 시작해서 SSL 2.0, SSL 3.0, TLS(TransportLayer Security Protocol) 1.0, TLS 1.3까지 버전이 올라간다.
마지막으로 TLS로 명칭이 변경됐다.

TLS는 전송 계층에서 보안을 제공하는 프로토콜이다.
클라이언트와 서버가 통신할 때, TLS를 통해 제 3자가 메시지를 도청하거나 변조하지 못하도록 한다.

사용할 TLS 버전을 정하고, 사이퍼슈트, 서버의 공개키, SSL인증서를 기반으로 인증작업을 수행한다.
그 이후에 대칭 암호화를 위해 세션키를 생성한다.

### 1. Client Hello

클라이언트는 TLS버전, 사이퍼슈트와 클라이언트 랜덤값(무작위 문자열), 임시 DH 매개변수를 서버에게 보낸다.

### 2. Server Hello, EncryptedExtensions, Certificate, CertificateVerify

서버는 클라이언트로부터 받은 옵션을 확인한다.
서버와 클라이언트 모두에서 지원하는 가장 높은 TLS 버전을 식별해 결정하고, 사이퍼슈트 지원 여부를 확인한다.
공개키가 포함된 SSL 인증서, 서버 랜덤값, 임시 DH 매개변수를 보낸다.

클라이언트와 서버 각각 서로 교환한 DH 매개변수를 사용해 임시 암호 키(세션키)를 생성한다.

### 3. Finished

클라이언트와 서버와 세션키를 기반으로 대칭 암호화된 통신이 시작된다. (보안세션이 시작됐다고 한다.)
키교환 알고리즘으로는 대표적으로 RSA와 DH가 있다.
여기서는 DH 기반으로 설명한다.

TLS 1.3버전에서는 RSA가 취약점이 있기 때문에, 공식적으로 지원하지 않는다.
DH의 경우, 타원곡선 DH를 사용한다.

### DH 매개변수

DH는 Diffie-Hellman을 의미한다.

이 알고리즘은 서로 공개값을 공유한다.
이후 각자의 비밀값과 혼합해 공통의 암호키를 만든다.

DH는 그냥 디피헬만을 사용하는 DHE와 타원곡선암호화 방법과 DH를 섞은 ECDHE가 있는데 ECDHE를 쓴다.

타원곡선 암호화 방법은 곡선을 사용해 개인 키 보유자만 알 수 있는 타원곡선을 그린다.
이걸 기반으로 교차점을 생성한다.
이 교차점의 수를 기반으로 암호를 설정한다.

### 사이퍼슈트

이는 프로토콜, AEAD 사이퍼 모드, 해싱 알고리즘이 나열된 규약이다.
암호제품군이라고도 불린다. TLS 1.3 버전에는 다섯 개가 있다.

예를 들어, TLS_AES_128_GCM_SHA256에는 세 가지 규약이 있다.
TLS = 프로토콜
AES_128_GCM = AEAD 사이퍼 모드
SHA256 = 해싱 알고리즘

#### AEAD 사이퍼 모드

AEAD(Authenticated Encryption with Associated Data)는 데이터 암호화 알고리즘이며, AES_128_GCM 등이 있다.

#### 해싱 알고르지므

데이터를 추정하기 힘든 더 작고, 섞여 있는 조각으로 만드는 알고리즘이다.
SSL/TLS는 해싱 알고리즘으로 SHA256 알고리즘과 SHA384 알고리즘을 쓰는데, 그 중 SHA256가 더 많이 쓰인다.
SHA256 알고리즘은 해시 함수의 결과값이 256비트인 알고리즘이다.
이는 비트 코인을 비롯한 많은 블록체인 시스템에서도 쓴다.

#### 해싱 알고리즘은 TLS에서 어떻게 쓰이나요?

인증서가 올바른 인증서인지 확인할 때 전자서명을 이용한다.
이때 해싱 알고리즘이 쓰인다.

1. 인증 생성작업 : 전자 서명을 만드는데 서명되는 메시지를 해싱한다.
2. 인증 확인작업 : 메시지를 복호화해서 해시를 서로 비교해 올바른 메시지인지 확인한다.

즉, 유효성 검증이란 인증서가 변조되지 않았고 인증서가 "서비스제공자"것임을 확인하는 절차다.

### 인증서

1. 주체 : 인증서를 발급한 CA, 도메인, 웹사이트 소유자, 인증서 소유자
2. 공개키 : 공개키, 공개키 암호화 방법

위 두 가지를 포함하는 단순한 데이터 파일이다.
자신의 웹사이트 안에서 SSL 인증서를 만들 수도 있지만, 보통은 인증기관인 CA에서 발급한 SSL 인증서를 기반으로 인증작업을 수행한다.

주체는 클라이언트가 접속한 서버가 클라이언트가 의도한 서버가 맞는지 확인할 때 쓰인다.
공개키는 처음 인증작업을 수행할 때 쓰인다.

### CA

인증서의 역할은 클라이언트가 접속한 서버가 클라이언트가 의도한 서버가 맞는지 보장하는 것이다.
이 인증서를 발급하는 기업을 CA라고 한다.
참고로 서비스 도메인, 공개키와 같은 정보는 서비스가 CA로부터 인증서를 구입할 때 제출해야 한다.

인증서는 다양한 유형의 인증서가 있다.

1. 단일 도메인 : 단 하나의 도메인에 적용되는 인증서
2. 와일드카드 : 도메인의 하위 도메인도 포함하는 인증서다. 예를 들어, www.cloudflare.com / blog.cloudflare.com
3. 멀티 도메인 : 이름이 의미하는 것처럼 멀티 도메인 SSL 인증서는 관련되지 않은 다수 도메인에 적용될 수 있는 인증서다.

### RSA 취약점

RSA는 클라이언트가 생성한 임시 암호값을 서버로 전송하지만, DH의 경우에는 클라이언트와 서버가 서로 교환한 DH 매개변수를 사용해 개인키를 만든다.
이 때문에 RSA는 클라이언트에서 생성한 임시 암호값이 탈취당하면 해킹의 위험이 있다.
그러나 DH는 탈취당해도 공통의 암호키를 못 만듥기 때문에 더 좋다.

### 0 - RTT

세션키가 생성된 이후, 다시 그 사이트에 방문하면 미리 만들어 놓은 세션키(PSK, pre-shared key)를 기반으로 연결을 생성한다.
그래서 이때 인증에 드는 비용이 없다.
즉, 인증에 관한 RTT가 발생되지 않기 때문에 0 - RTT 라는 특징을 갖는다.

#### 왜 네트워크상 보안을 해야 하나요?

신용카드 등 민감한 금융정보를 다루는데 이점이 있고, HTTP/2를 구현할 수 있다.
HTTP/2는 HTTPS에서만 돌아간다.

#### 웹사이트가 SSL을 잘 수행하는지?

[확인 링크](https://www.ssllabs.com/ssltest/)

구글도 B다. B면 괜찮다.
